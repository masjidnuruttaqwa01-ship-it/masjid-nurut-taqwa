<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kompas Qiblat Sultan</title>

<style>
body{
  margin:0;
  height:100vh;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  background:radial-gradient(circle at center,#0f9d58,#063d29);
  font-family:'Poppins',sans-serif;
  color:white;
  overflow:hidden;
}

/* TITLE */
h1{
  margin-bottom:5px;
  font-size:22px;
  font-weight:600;
}
h2{
  margin:0;
  font-size:18px;
  opacity:.9;
}

/* COMPASS */
.compass-wrap{
  position:relative;
  margin-top:25px;
}

.compass{
  width:300px;
  height:300px;
  border-radius:50%;
  background:
    radial-gradient(circle at 50% 50%,#1d7c52,#0a3f2b);
  box-shadow:
    inset 0 0 40px rgba(255,215,0,.2),
    0 30px 60px rgba(0,0,0,.6);
  position:relative;
}

.arrow{
  position:absolute;
  width:8px;
  height:140px;
  background:linear-gradient(to top,gold,#fff3b0);
  left:50%;
  top:50%;
  transform-origin:50% 100%;
  transform:translate(-50%,-100%) rotate(0deg);
  border-radius:10px;
  box-shadow:0 0 25px gold;
  transition:transform .1s linear;
}

.center-dot{
  position:absolute;
  width:20px;
  height:20px;
  background:white;
  border-radius:50%;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  box-shadow:0 0 15px white;
}

/* KAABA GLOW */
.kaaba{
  position:absolute;
  width:40px;
  height:40px;
  background:black;
  border-radius:6px;
  left:50%;
  top:20px;
  transform:translateX(-50%);
  box-shadow:0 0 30px gold;
}

/* BUTTON */
button{
  margin-top:25px;
  padding:14px 35px;
  border:none;
  border-radius:30px;
  background:linear-gradient(135deg,#ffd700,#c9a227);
  font-weight:600;
  font-size:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.4);
}

/* STATUS */
#status{
  margin-top:15px;
  font-size:14px;
  text-align:center;
  min-height:20px;
}
</style>
</head>

<body>

<h1>ðŸ§­ Kompas Qiblat</h1>
<h2>Masjid Nurut Taqwa</h2>

<div class="compass-wrap">
  <div class="compass">
    <div class="kaaba"></div>
    <div class="arrow" id="arrow"></div>
    <div class="center-dot"></div>
  </div>
</div>

<button onclick="startCompass()">Aktifkan Kompas</button>
<div id="status">Siap digunakan</div>

<script>
let qiblaAngle = 0;
let smoothedHeading = 0;
let vibrationDone = false;

/* ===============================
   HITUNG ARAH KA'BAH
=================================*/
function calculateQibla(lat, lon){
  const kaabaLat = 21.4225 * Math.PI/180;
  const kaabaLon = 39.8262 * Math.PI/180;

  lat *= Math.PI/180;
  lon *= Math.PI/180;

  const dLon = kaabaLon - lon;

  const y = Math.sin(dLon);
  const x = Math.cos(lat)*Math.tan(kaabaLat) -
            Math.sin(lat)*Math.cos(dLon);

  let brng = Math.atan2(y,x);
  brng = brng * 180/Math.PI;
  return (brng + 360) % 360;
}

/* ===============================
   START
=================================*/
function startCompass(){

  if(!navigator.geolocation){
    status.innerText="GPS tidak didukung";
    return;
  }

  status.innerText="Mengambil lokasi...";

  navigator.geolocation.getCurrentPosition(pos=>{
    qiblaAngle = calculateQibla(
      pos.coords.latitude,
      pos.coords.longitude
    );

    status.innerText="Gerakkan HP angka 8 untuk kalibrasi";

    window.addEventListener("deviceorientationabsolute", handleOrientation, true);
    window.addEventListener("deviceorientation", handleOrientation, true);

  },()=>{
    status.innerText="Gagal mengambil lokasi";
  });
}

/* ===============================
   SENSOR FUSION + SMOOTHING
=================================*/
function handleOrientation(event){

  let heading;

  if(event.absolute && event.alpha !== null){
    heading = event.alpha;
  }
  else if(event.webkitCompassHeading){
    heading = event.webkitCompassHeading;
  }
  else if(event.alpha !== null){
    heading = 360 - event.alpha;
  }
  else return;

  /* SMOOTHING */
  smoothedHeading = smoothedHeading * 0.85 + heading * 0.15;

  const rotation = qiblaAngle - smoothedHeading;

  arrow.style.transform =
    `translate(-50%,-100%) rotate(${rotation}deg)`;

  const diff = Math.abs(rotation % 360);

  if(diff < 4){
    status.innerHTML="<b style='color
