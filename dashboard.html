<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Keuangan DKM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Poppins,sans-serif;
  background:linear-gradient(180deg,#064e3b,#0f766e);
  color:#fff;
}
.header{
  background:#064e3b;
  padding:14px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.header h1{font-size:16px;margin:0}
.logout{
  background:#dc2626;border:none;color:#fff;padding:8px 14px;border-radius:12px;font-weight:600
}
.container{padding:16px}

.summary{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
  margin-bottom:18px;
}
.box{
  background:#fff;
  color:#064e3b;
  padding:16px;
  border-radius:16px;
}
.table-box{
  background:#fff;
  color:#064e3b;
  border-radius:18px;
  overflow:hidden;
  margin-bottom:20px;
}
.table-box table{width:100%;border-collapse:collapse;font-size:12px}
.table-box th{background:#064e3b;color:#fff;padding:10px}
.table-box td{padding:10px;border-bottom:1px solid #eee}

.form{
  background:#fff;
  color:#064e3b;
  padding:18px;
  border-radius:18px;
}
.form input{
  width:100%;
  padding:12px;
  margin-bottom:10px;
  border-radius:10px;
  border:1px solid #ccc;
}
.form button{
  width:100%;
  background:#064e3b;
  color:#fff;
  border:none;
  padding:12px;
  border-radius:12px;
  font-weight:700;
}
</style>
</head>

<body>

<div class="header">
  <h1>ðŸ“Š Keuangan Masjid</h1>
  <button class="logout" onclick="logout()">Logout</button>
</div>

<div class="container">

<div class="summary">
  <div class="box">Saldo<br><b id="saldo">Rp 0</b></div>
  <div class="box">Transaksi<br><b id="jumlah">0</b></div>
  <div class="box">Masuk<br><b id="masukTotal">Rp 0</b></div>
  <div class="box">Keluar<br><b id="keluarTotal">Rp 0</b></div>
</div>

<div class="table-box">
<table>
<thead>
<tr><th>Tgl</th><th>Keterangan</th><th>Masuk</th><th>Keluar</th><th>Bukti</th></tr>
</thead>
<tbody id="list"></tbody>
</table>
</div>

<div class="form" id="formInput">
<h3>Tambah Transaksi</h3>
<input type="date" id="tgl">
<input type="text" id="ket" placeholder="Keterangan">
<input type="number" id="masuk" placeholder="Pemasukan">
<input type="number" id="keluar" placeholder="Pengeluaran">
<input type="file" id="foto" accept="image/*">
<button onclick="simpan()">ðŸ’¾ Simpan Transaksi</button>
</div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwnZiqtiUv0cBgrHBlhSZNpjqVymAssJOvz0XpjcPA8ESPeLOLsSnoIYv5yXxw5BxqM/exec";

/* ===== CEK LOGIN ===== */
if(localStorage.getItem("login") !== "true"){
  location="login.html";
}

const role = localStorage.getItem("role");

/* ===== SEMBUNYIKAN FORM JIKA ANGGOTA ===== */
if(role==="anggota"){
  document.getElementById("formInput").style.display="none";
}

/* ===== LOAD DATA ===== */
function loadData(){
 fetch(API_URL)
 .then(r=>r.json())
 .then(rows=>{
   let html="", saldo=0, masukT=0, keluarT=0;

   rows.forEach(r=>{
     saldo = r[4];
     masukT += Number(r[2]);
     keluarT += Number(r[3]);
     html+=`
       <tr>
         <td>${r[0]}</td>
         <td>${r[1]}</td>
         <td>${r[2]}</td>
         <td>${r[3]}</td>
         <td>${r[5]?`<a href="${r[5]}" target="_blank">ðŸ“·</a>`:"-"}</td>
       </tr>
     `;
   });

   list.innerHTML=html;
   saldo.innerText="Rp "+saldo;
   masukTotal.innerText="Rp "+masukT;
   keluarTotal.innerText="Rp "+keluarT;
   jumlah.innerText=rows.length;
 });
}

/* ===== SIMPAN ===== */
function simpan(){
 if(role!=="bendahara"){ alert("Hanya bendahara"); return; }

 const tgl=tglInput.value;
 const ket=ketInput.value;
 const masuk=masukInput.value;
 const keluar=keluarInput.value;
 const foto=fotoInput.files[0];

 if(!tgl||!ket){ alert("Lengkapi data"); return; }

 const fd=new FormData();
 fd.append("tgl",tgl);
 fd.append("ket",ket);
 fd.append("masuk",masuk);
 fd.append("keluar",keluar);

 if(foto){
   const r=new FileReader();
   r.onload=()=>{ fd.append("foto",r.result); kirim(fd); }
   r.readAsDataURL(foto);
 }else kirim(fd);
}

function kirim(fd){
 fetch(API_URL,{method:"POST",body:fd})
 .then(r=>r.text())
 .then(()=>{
   alert("Tersimpan");
   loadData();
 });
}

function logout(){
 localStorage.clear();
 location="login.html";
}

loadData();
</script>

</body>
</html>
